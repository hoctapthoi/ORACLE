###### DG discount because miss a datafile #############
### 1. verify connection ###
tnsping xxx
tnsping xxxDB
SQL> sqlplus sys/Abcd123@xxx as sysdba
SQL> SELECT name, open_mode, database_role FROM v$database;
SQL> EXIT;

SQL> sqlplus sys/Abcd123@xxxDB as sysdba
SQL> SELECT name, open_mode, database_role FROM v$database;
SQL> EXIT;

```bash
# Password file phải giống nhau trên cả Primary và Standby
ls -l $ORACLE_HOME/dbs/orapwxxx
ls -l $ORACLE_HOME/dbs/orapwxxxDB

**Trên Standby:**
```sql
-- Kiểm tra datafile có vấn đề
SELECT FILE#, NAME, STATUS, ERROR 
FROM V$DATAFILE 
WHERE STATUS != 'ONLINE' OR ERROR IS NOT NULL;

-- FILE#  NAME                                          STATUS   ERROR
-- -----  --------------------------------------------  -------  --------
-- 14     /oracledata/data/xxxDB/users02.dbf          RECOVER  FILE NOT FOUND

**Kiểm tra Apply Lag:**
```bash
dgmgrl / <<EOF
SHOW DATABASE xxxDB;
EXIT;
EOF

# Chú ý: Apply Lag: 4 hours 21 minutes
```

### 2.3. Kiểm tra GAP
-- Kiểm tra archive log gap
SELECT * FROM V$ARCHIVE_GAP;

-- Nếu có gap, cần resolve trước khi proceed

### sử dụng RECOVER FROM SERVICE để khôi phục ###
```bash
# Kết nối với cả TARGET (Standby) và AUXILIARY (Primary)
rman TARGET sys/Abcd123@xxxDB AUXILIARY sys/Abcd123@xxx

# tạo missing datafile sau đó recover database from service
RMAN> RUN {
  SET NEWNAME FOR DATAFILE 14 TO '/oracledata/data/xxxDB/users02.dbf';
  RESTORE DATAFILE 14 FROM SERVICE 'xxx';
  SWITCH DATAFILE 14;
  RECOVER DATABASE;
}

# khởi động MRP service:
dgmgrl sys/Abcd123@xxx
EDIT DATABASE xxxDB SET STATE='APPLY-ON';

# check MRP service state
DGMGRL> show database xxxDB
SQL> SELECT PROCESS, STATUS, THREAD#, SEQUENCE# 
FROM V$MANAGED_STANDBY 
WHERE PROCESS LIKE 'MRP%';

