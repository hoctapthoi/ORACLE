###Grid installation for OEL8
#new
mount /dev/cdrom /mnt
cd /etc/yum.repos.d/
mkdir bak
mv *.repo bak

sudo tee /etc/yum.repos.d/local.repo > /dev/null <<'EOF'
[local1]
enabled=1
gpgcheck=0
baseurl=file:///mnt/BaseOS

[local2]
enabled=1
gpgcheck=0
baseurl=file:///mnt/AppStream
EOF

yum install -y oracle-database-preinstall* *oracleasm* net-tools telnet

sudo tee -a /etc/hosts > /dev/null <<'EOF'
# Public
192.168.56.121 node1.localdomain node1
192.168.56.122 node2.localdomain node2
192.168.56.200 ntp.localdomain ntp

# Private
192.168.159.121 node1-priv.localdomain node1-priv
192.168.159.122 node2-priv.localdomain node2-priv

# Virtual
192.168.56.131 node1-vip.localdomain node1-vip
192.168.56.132 node2-vip.localdomain node2-vip

# SCAN
192.168.56.141 node-scan.localdomain node-scan
192.168.56.142 node-scan.localdomain node-scan
192.168.56.143 node-scan.localdomain node-scan
EOF

groupadd -g 54327 asmdba
groupadd -g 54328 asmoper
groupadd -g 54329 asmadmin
useradd -u 54322 -g oinstall -G dba,oper,asmdba,asmoper,asmadmin,racdba grid
usermod -G asmdba,asmoper,asmadmin oracle
echo "123" | sudo passwd --stdin grid

echo "123" | sudo passwd --stdin oracle

#yum install -y kmod-redhat-oracleasm.x86_64

systemctl stop firewalld
systemctl disable firewalld

setenforce 0
sudo sed -i 's/^SELINUX=.*/SELINUX=permissive/' /etc/selinux/config

mkdir -p /u01/app/19c/grid
mkdir -p /u01/app/grid
mkdir -p /u01/app/oracle/product/19c/db_1
chown -R grid:oinstall /u01
chown oracle:oinstall /u01/app/oracle
chmod -R 775 /u01/

sudo tee -a /home/oracle/.bash_profile > /dev/null <<'EOF'
HOSTNAME=$(hostname)
SID_SUFFIX=$(echo "$HOSTNAME" | grep -o '[0-9]\+$' | sed 's/^0*//') 
if [ -n "$SID_SUFFIX" ]; then 
    export ORACLE_SID="orcl$SID_SUFFIX" 
else 
     export ORACLE_SID="orcl" 
fi
export TMP=/tmp
export TMPDIR=$TMP
export ORACLE_BASE=/u01/app/oracle
#export GRID_HOME=/u01/app/19c/grid
export DB_HOME=$ORACLE_BASE/product/19c/db_1
export ORACLE_HOME=$DB_HOME
#export ORACLE_SID=orcl
export ORACLE_TERM=xterm
#export BASE_PATH=/usr/sbin:$PATH
export PATH=$ORACLE_HOME/bin:$PATH
export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib
umask 022
EOF

sudo tee -a /home/oracle/.bashrc > /dev/null <<'EOF'
alias ss='sqlplus / as sysdba'
EOF
sudo tee -a /home/grid/.bashrc > /dev/null <<'EOF'
alias ss='sqlplus / as sysasm'
EOF

sudo tee -a /home/grid/.bash_profile > /dev/null <<'EOF'
HOSTNAME=$(hostname)
SID_SUFFIX=$(echo "$HOSTNAME" | grep -o '[0-9]\+$' | sed 's/^0*//') 
if [ -n "$SID_SUFFIX" ]; then 
    export ORACLE_SID="+ASM$SID_SUFFIX" 
else 
     export ORACLE_SID="+ASM" 
fi
#export ORACLE_SID=+ASM1
export ORACLE_HOME=/u01/app/19c/grid
export PATH=$ORACLE_HOME/bin:$PATH
export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/lib:/usr/lib
export CLASSPATH=$ORACLE_HOME/JRE:$ORACLE_HOME/jlib:$ORACLE_HOME/rdbms/jlib
umask 022
EOF

chmod u+x /home/grid/.bash_profile
chmod u+x /home/oracle/.bash_profile
chmod u+x /home/grid/.bashrc
chmod u+x /home/oracle/.bashrc

mv /etc/profile /etc/profile.bak
tee /etc/profile > /dev/null <<'EOF'
#profile
# /etc/profile
# System wide environment and startup programs, for login setup
# Functions and aliases go in /etc/bashrc
pathmunge () {
      if ! echo $PATH | /bin/egrep -q "(^|:)$1($|:)" ; then
            if [ "$2" = "after" ] ; then
                  PATH=$PATH:$1
            else
                  PATH=$1:$PATH
            fi
      fi
}
# ksh workaround
if [ -z "$EUID" -a -x /usr/bin/id ]; then
      EUID=`id -u`
      UID=`id -ru`
fi
# Path manipulation
if [ "$EUID" = "0" ]; then
pathmunge /sbin
pathmunge /usr/sbin
pathmunge /usr/local/sbin
fi
# No core files by default
ulimit -S -c 0 > /dev/null 2>&1
if [ -x /usr/bin/id ]; then
      USER="`id -un`"
      LOGNAME=$USER
      MAIL="/var/spool/mail/$USER"
fi
HOSTNAME=`/bin/hostname`
HISTSIZE=1000
if [ -z "$INPUTRC" -a ! -f "$HOME/.inputrc" ]; then
      INPUTRC=/etc/inputrc
fi
export PATH USER LOGNAME MAIL HOSTNAME HISTSIZE INPUTRC
for i in /etc/profile.d/*.sh ; do
      if [ -r "$i" ]; then
            . $i
      fi
done
if [ $USER = "oracle" ] || [ $USER = "grid" ]; then
      umask 022
      if [ $SHELL = "/bin/ksh" ]; then
            ulimit -p 16384
            ulimit -n 65536
      else
            ulimit -u 16384 -n 65536
      fi
fi
unset i
unset pathmunge
EOF

cp /etc/security/limits.conf /etc/security/limits.conf.bak
tee -a /etc/security/limits.conf > /dev/null <<'EOF'
oracle soft nofile 131072
oracle hard nofile 131072
oracle soft nproc 131072
oracle hard nproc 131072
oracle soft core unlimited
oracle hard core unlimited
oracle soft memlock 3500000
oracle hard memlock 3500000
grid soft nofile 131072
grid hard nofile 131072
grid soft nproc 131072
grid hard nproc 131072
grid soft core unlimited
grid hard core unlimited
grid soft memlock 3500000
grid hard memlock 3500000
# Recommended stack hard limit 32MB for oracle installations
# oracle hard stack 32768
EOF

copy and unzip  grid.zip
cd /u01/app/19c/grid/deinstall
./sshUserSetup.sh -user grid -hosts "node1 node2" -noPromptPassphrase -confirm -advanced

cd /u01/app/19c/grid/cv/rpm
rpm -Uvh cvuqdisk-1.0.10-1.rpm

oracleasm configure -i
oracleasm init

#node1:
fdisk /dev/sdb
...
lsblk -f

#node2:
partprobe
lsblk -f

#node1:
oracleasm createdisk DATA01 /dev/sdb1
oracleasm createdisk DATA02 /dev/sdc1

oracleasm createdisk OCR01 /dev/sdd1
oracleasm createdisk OCR02 /dev/sde1
oracleasm createdisk OCR03 /dev/sdf1

oracleasm scandisks
oracleasm listdisks

#ls -ltr /dev/oracleasm/disks

#node2:
oracleasm scandisks
oracleasm listdisks

#node1:
mkdir -p /u01/app/oraInventory
cd $ORACLE_HOME
export CV_ASSUME_DISTID=OEL8 #it for bypass sshpasswordless bug
sudo chown -R grid:oinstall .

# fix passwordless issue on both node
mv /usr/bin/scp /usr/bin/scp.bak
sudo tee /usr/bin/scp > /dev/null << 'EOF'
#!/bin/bash
/usr/bin/scp.bak -T "$@"
EOF
chmod a+rx /usr/bin/scp
cat /usr/bin/scp

# install grid
./gridSetup.sh
./runcluvfy.sh comp nodecon -n node1,node2 -verbose

# reset/rollback scp
sudo rm /usr/bin/scp
sudo mv /usr/bin/scp.bak /usr/bin/scp
file /usr/bin/scp


